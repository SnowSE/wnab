<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:WNAB.MVM;assembly=WNAB.MVM"
             xmlns:data="clr-namespace:WNAB.Data;assembly=WNAB.Data"
             x:Class="WNAB.Maui.CategoriesPage"
             x:DataType="local:CategoriesViewModel"
             Title="Categories">
    
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Home"
                     Priority="1"
                     Order="Primary"
                     Command="{Binding NavigateToHomeCommand}" />
    </ContentPage.ToolbarItems>
    
    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="16">
            <!-- Add Category Button -->
            <Button CornerRadius="8"
                    HorizontalOptions="End"
                    Command="{Binding ToggleAddFormCommand}"
                    IsEnabled="{Binding Model.IsLoggedIn}"
                    VerticalOptions="Center">
                <Button.Text>
                    <Binding Path="IsAddFormVisible">
                        <Binding.Converter>
                            <converters:BoolToTextConverter xmlns:converters="clr-namespace:WNAB.Maui.Converters" 
                                                            TrueText="Cancel"
                                                            FalseText="+ Add Category" />
                        </Binding.Converter>
                    </Binding>
                </Button.Text>
                <Button.Padding>
                    <OnIdiom x:TypeArguments="Thickness"
                             Phone="12,8"
                             Tablet="14,10"
                             Desktop="16,12" />
                </Button.Padding>
            </Button>

            <!-- Inline Add Category Form -->
            <Border IsVisible="{Binding IsAddFormVisible}"
                    Padding="16"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                    StrokeShape="RoundRectangle 12"
                    Margin="0,8">
                <VerticalStackLayout Spacing="12">
                    <Label Text="âž• Create New Category"
                           FontSize="20"
                           FontAttributes="Bold" />

                    <!-- Error Message -->
                    <Label Text="{Binding AddCategoryModel.ErrorMessage}"
                           IsVisible="{Binding AddCategoryModel.ErrorMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                           TextColor="Red"
                           FontSize="14" />

                    <!-- Category Name -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Category Name" FontAttributes="Bold" />
                        <Entry Text="{Binding AddCategoryModel.Name}"
                               Placeholder="Enter category name"
                               BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                    </VerticalStackLayout>

                    <!-- Color Picker -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Color" FontAttributes="Bold" />
                        <HorizontalStackLayout Spacing="8"
                                               BindableLayout.ItemsSource="{Binding AddCategoryModel.ColorOptions}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Ellipse Fill="{Binding ., Converter={StaticResource StringToColorConverter}}" 
                                             WidthRequest="36" 
                                             HeightRequest="36" 
                                             StrokeThickness="3">
                                        <Ellipse.Stroke>
                                            <MultiBinding Converter="{StaticResource ColorSelectionMultiConverter}">
                                                <Binding Path="." />
                                                <Binding Source="{RelativeSource AncestorType={x:Type local:CategoriesViewModel}}" Path="AddCategoryModel.SelectedColor" />
                                            </MultiBinding>
                                        </Ellipse.Stroke>
                                        <Ellipse.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnColorTapped" CommandParameter="{Binding .}" />
                                        </Ellipse.GestureRecognizers>
                                    </Ellipse>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                        <Button Text="Cancel"
                                Command="{Binding CancelAddCategoryCommand}"
                                BackgroundColor="Gray"
                                TextColor="White" />
                        <Button Grid.Column="1"
                                Text="Create Category"
                                Command="{Binding SaveNewCategoryCommand}"
                                BackgroundColor="#28A745"
                                TextColor="White"
                                IsEnabled="{Binding AddCategoryModel.IsBusy, Converter={StaticResource InvertedBoolConverter}}" />
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- Login prompt when not logged in -->
            <Label Text="Please use the Login page to sign in first." 
                   IsVisible="{Binding Model.IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                   HorizontalOptions="Center" 
                   TextColor="Orange"
                   Margin="0,10" />

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding Model.IsBusy}" 
                             IsVisible="{Binding Model.IsBusy}"
                             Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />

            <!-- Categories List -->
            <VerticalStackLayout IsVisible="{Binding Model.IsLoggedIn}" Spacing="16">
                <!-- Categories Collection -->
                <CollectionView ItemsSource="{Binding Model.Items}">
                    <CollectionView.EmptyView>
                        <Label Text="No categories yet." 
                               HorizontalOptions="Center" 
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="local:CategoryItemViewModel">
                            <!-- Category Card -->
                            <Border BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray900}}"
                                    Margin="0,0,0,12"
                                    Padding="16">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                                    <!-- View Mode: Category Name Row -->
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12"
                                          IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                                        <!-- Color Dot -->
                                        <BoxView Color="{Binding Color}"
                                                 WidthRequest="12"
                                                 HeightRequest="12"
                                                 CornerRadius="6"
                                                 VerticalOptions="Center" />
                                        
                                        <!-- Category Name -->
                                        <Label Grid.Column="1"
                                               Text="{Binding Name}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center" />
                                        
                                        <!-- Edit Button -->
                                        <Label Grid.Column="2"
                                               Text="âœï¸"
                                               FontSize="20"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:CategoriesViewModel}}, Path=EditCategoryInlineCommand}"
                                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        
                                        <!-- Delete Button -->
                                        <Label Grid.Column="3"
                                               Text="ðŸ—‘ï¸"
                                               FontSize="20"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:CategoriesViewModel}}, Path=DeleteCategoryCommand}"
                                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>

                                    <!-- Edit Mode: Category Name Entry with Save/Cancel -->
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8"
                                          IsVisible="{Binding IsEditing}">
                                        <Entry Text="{Binding EditName}"
                                               VerticalOptions="Center"
                                               Placeholder="Category Name"
                                               FontSize="14"
                                               HeightRequest="40" />
                                        
                                        <!-- Save Button -->
                                        <Label Grid.Column="1"
                                               Text="âœ…"
                                               FontSize="20"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:CategoriesViewModel}}, Path=SaveCategoryInlineCommand}"
                                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        
                                        <!-- Cancel Button -->
                                        <Label Grid.Column="2"
                                               Text="âŒ"
                                               FontSize="20"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:CategoriesViewModel}}, Path=CancelEditCategoryInlineCommand}"
                                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>

                                    <!-- Edit Mode: Color Picker (colors from CategoryItemViewModel.AvailableColors) -->
                                    <HorizontalStackLayout Grid.Row="1" Spacing="8" IsVisible="{Binding IsEditing}"
                                                           BindableLayout.ItemsSource="{Binding AvailableColors}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="x:String">
                                                <Ellipse Fill="{Binding ., Converter={StaticResource StringToColorConverter}}" WidthRequest="28" HeightRequest="28" StrokeThickness="3">
                                                    <Ellipse.Stroke>
                                                        <MultiBinding Converter="{StaticResource ColorSelectionMultiConverter}">
                                                            <Binding Path="." />
                                                            <Binding Source="{RelativeSource AncestorType={x:Type local:CategoryItemViewModel}}" Path="EditColor" />
                                                        </MultiBinding>
                                                    </Ellipse.Stroke>
                                                    <Ellipse.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:CategoryItemViewModel}}, Path=SelectColorCommand}"
                                                                              CommandParameter="{Binding .}" />
                                                    </Ellipse.GestureRecognizers>
                                                </Ellipse>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </HorizontalStackLayout>
                                    
                                    <!-- Amount Section (always visible) -->
                                    <VerticalStackLayout Grid.Row="2" Spacing="4">
                                        <Label Text="$0.00"
                                               FontSize="24"
                                               FontAttributes="Bold" />
                                        <Label Text="Total spent"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>

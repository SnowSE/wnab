<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WNAB.Maui.PlanBudgetPage"
             Title="Plan Budget">


    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Home"
                     Priority="1"
                     Order="Primary"
                     Command="{Binding NavigateToHomeCommand}" />
    </ContentPage.ToolbarItems>
    <!-- LLM-Dev: Grid layout with categories column on left (togglable), content area on right, and bottom toolbar -->
    <!-- LLM-Dev v2: Changed row definitions to ensure bottom toolbar is always visible -->
    <!-- LLM-Dev v3: Changed column definition from Auto to 250 to prevent content overflow when categories visible -->
    <Grid ColumnDefinitions="250,*" RowDefinitions="*,Auto">
        
        <!-- LLM-Dev: Left column - Categories list following MVVM pattern, visibility controlled by IsCategoriesVisible -->
        <!-- LLM-Dev v3: Removed WidthRequest since Grid column now defines width, prevents layout issues -->
        <Border Grid.Column="0" 
                Grid.RowSpan="1"
                Padding="10"
                IsVisible="{Binding IsCategoriesVisible}"
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                StrokeThickness="0">
            <VerticalStackLayout Spacing="10">
                <Label Text="Categories" 
                       FontSize="20" 
                       FontAttributes="Bold"
                       Margin="0,0,0,5"/>
                
                <!-- LLM-Dev: Button to create a new category -->
                <Button Text="+ New Category"
                        Command="{Binding AddCategoryCommand}"
                        FontSize="14"
                        Padding="8,4"
                        Margin="0,0,0,10"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                
                <!-- LLM-Dev: Available categories - clicking moves them to selected list -->
                <CollectionView ItemsSource="{Binding Categories}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border Padding="10,8"
                                    Margin="0,2"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                                    StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectCategoryCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>
                                <Label Text="{Binding Name}" 
                                       FontSize="16"/>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <!-- LLM-Dev: Status message for loading/error feedback -->
                <Label Text="{Binding StatusMessage}" 
                       FontSize="12"
                       IsVisible="{Binding IsBusy}"
                       Margin="0,10,0,0"/>
            </VerticalStackLayout>
        </Border>
        
        <!-- LLM-Dev: Center column - Budget planning content area with selected categories -->
        <!-- LLM-Dev v2: Explicitly set Grid.RowSpan to 1 to ensure ScrollView doesn't overlap bottom toolbar -->
        <ScrollView Grid.Column="1"
                    Grid.RowSpan="1"
                    Padding="30,20">
            <VerticalStackLayout Spacing="20">
                
                <!-- LLM-Dev: Button to toggle categories list visibility -->
                <Button Text="Add Category to Plan"
                        Command="{Binding ToggleCategoriesVisibilityCommand}"
                        HorizontalOptions="Start"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                
                <!-- LLM-Dev: Selected categories for budget planning -->
                <VerticalStackLayout Spacing="10">
                    <Label Text="Budget Categories" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           Margin="0,10,0,10"/>
                    
                    <CollectionView ItemsSource="{Binding SelectedCategories}"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="15,10"
                                        Margin="0,5"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                                        StrokeThickness="1"
                                        Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}">
                                    <!-- LLM-Dev v2: Vertical layout with category name on top, budget entry below, and remove button in corner -->
                                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                                        <!-- LLM-Dev v2: Category name at top -->
                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding Name}" 
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               Margin="0,0,0,8"/>
                                        
                                        <!-- LLM-Dev v2: Remove button in top-right corner -->
                                        <Label Grid.Row="0" Grid.Column="1"
                                               Text="âœ•"
                                               FontSize="18"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                               VerticalOptions="Start"
                                               HorizontalOptions="End">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeselectCategoryCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        
                                        <!-- LLM-Dev v2: Budget entry field below category name -->
                                        <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Spacing="5">
                                            <Label Text="Budget Amount: $" 
                                                   FontSize="14"
                                                   VerticalOptions="Center"/>
                                            <Entry Text="{Binding BudgetAmount, Mode=TwoWay}"
                                                   Keyboard="Numeric"
                                                   WidthRequest="150"
                                                   Placeholder="0.00"
                                                   VerticalOptions="Center"
                                                   HorizontalTextAlignment="End"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    
                    <!-- LLM-Dev: Empty state message when no categories selected -->
                    <Label Text="No categories added to plan yet. Click 'Add Category to Plan' to get started."
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                           HorizontalTextAlignment="Center"
                           Margin="0,20,0,0"
                           IsVisible="{Binding SelectedCategories.Count, Converter={StaticResource IsNotNullOrEmptyConverter}}"/>
                </VerticalStackLayout>
                    
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- LLM-Dev: Bottom toolbar with Save and Cancel buttons -->
        <Border Grid.Row="1" 
                Grid.ColumnSpan="2"
                Padding="20,10"
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                StrokeThickness="0">
            <HorizontalStackLayout Spacing="10" 
                                   HorizontalOptions="End">
                <Button Text="Cancel" 
                        WidthRequest="100"
                        Command="{Binding CancelCommand}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}" />
                <Button Text="Save" 
                        WidthRequest="100"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}" />
            </HorizontalStackLayout>
        </Border>
    </Grid>
</ContentPage>

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:WNAB.MVM;assembly=WNAB.MVM"
             xmlns:behaviors="clr-namespace:WNAB.Maui.Behaviors"
             xmlns:dto="clr-namespace:WNAB.SharedDTOs;assembly=WNAB.SharedDTOs"
             x:Class="WNAB.Maui.TransactionsPage"
             x:DataType="local:TransactionsViewModel"
             Title="Transactions"
             BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Home"
                     Priority="1"
                     Order="Primary"
                     Command="{Binding NavigateToHomeCommand}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16"
                             Spacing="16">

            <!-- Page Header -->
            <Grid ColumnDefinitions="*,Auto,Auto"
                  ColumnSpacing="12"
                  RowSpacing="8">
                <Label Grid.Column="0"
                       Text="Transactions"
                       FontSize="28"
                       FontAttributes="Bold"
                       VerticalOptions="Center" />
                <Button Grid.Column="1"
                        Text="{Binding IsAddFormVisible, Converter={StaticResource AddFormButtonTextConverter}}"
                        Command="{Binding ToggleAddFormCommand}"
                        IsEnabled="{Binding Model.IsLoggedIn}"
                        CornerRadius="8"
                        VerticalOptions="Center">
                    <Button.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="12,8"
                                 Tablet="14,10"
                                 Desktop="16,12" />
                    </Button.Padding>
                </Button>
                <Button Grid.Column="2"
                        Text="Refresh"
                        Command="{Binding RefreshCommand}"
                        CornerRadius="8"
                        VerticalOptions="Center">
                    <Button.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="8,6"
                                 Tablet="10,8"
                                 Desktop="12,10" />
                    </Button.Padding>
                </Button>
            </Grid>

            <!-- Login prompt when not logged in -->
            <Border IsVisible="{Binding Model.IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                    Padding="16"
                    StrokeThickness="1"
                    Stroke="Orange"
                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                    StrokeShape="RoundRectangle 8">
                <Label Text="âš ï¸ Please log in to view transactions."
                       TextColor="Orange"
                       HorizontalOptions="Center"
                       FontAttributes="Bold" />
            </Border>

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding Model.IsBusy}"
                               IsVisible="{Binding Model.IsBusy}"
                               Color="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />

            <!-- Inline Add Transaction Form -->
            <Border x:Name="AddTransactionForm"
                    IsVisible="{Binding IsAddFormVisible}"
                    Padding="16"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                    StrokeShape="RoundRectangle 12"
                    Margin="0,8">
                <VerticalStackLayout Spacing="12">
                    <Label Text="âž• Create New Transaction"
                           FontSize="20"
                           FontAttributes="Bold" />

                    <!-- Status Message -->
                    <Border IsVisible="{Binding AddTransactionViewModel.Model.StatusMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                            Padding="12"
                            BackgroundColor="#FFEBEE"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                        <Label Text="{Binding AddTransactionViewModel.Model.StatusMessage}"
                               TextColor="DarkRed" />
                    </Border>

                    <!-- Account and Date Row -->
                    <Grid ColumnDefinitions="*,*"
                          ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0"
                                             Spacing="4">
                            <Label Text="Account"
                                   FontAttributes="Bold" />
                            <Picker ItemsSource="{Binding AddTransactionViewModel.Model.AvailableAccounts}"
                                    ItemDisplayBinding="{Binding AccountName}"
                                    SelectedItem="{Binding AddTransactionViewModel.Model.SelectedAccount}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="4">
                            <Label Text="Date"
                                   FontAttributes="Bold" />
                            <DatePicker Date="{Binding AddTransactionViewModel.Model.TransactionDate}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Payee and Amount Row -->
                    <Grid ColumnDefinitions="*,*"
                          ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0"
                                             Spacing="4">
                            <Label Text="Payee"
                                   FontAttributes="Bold" />
                            <Entry Text="{Binding AddTransactionViewModel.Model.Payee}"
                                   Placeholder="Enter payee name"
                                   PlaceholderColor="Gray"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="4">
                            <Label Text="Amount"
                                   FontAttributes="Bold" />
                            <Entry Text="{Binding AddTransactionViewModel.Model.Amount}"
                                   Placeholder="0.00"
                                   Keyboard="Numeric"
                                   PlaceholderColor="Gray"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Splits Section (always visible) -->
                    <VerticalStackLayout Spacing="12">
                        <HorizontalStackLayout Spacing="4">
                            <Label Text="Category"
                                   FontAttributes="Bold"
                                   FontSize="16" />
                            <Label Text="{Binding AddTransactionViewModel.Model.TransactionDate, StringFormat='(for {0:MMMM yyyy})'}"
                                   FontSize="12"
                                   TextColor="Gray"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>

                        <CollectionView ItemsSource="{Binding AddTransactionViewModel.Model.Splits}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="local:AddTransactionSplitViewModel">
                                    <Border Padding="12"
                                            Margin="0,4"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                            Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 6">
                                        <Grid ColumnDefinitions="*,Auto,Auto"
                                              ColumnSpacing="8"
                                              RowSpacing="8">
                                            <VerticalStackLayout Grid.Column="0"
                                                                 Spacing="4">
                                                <Label Text="Category"
                                                       FontSize="12"
                                                       TextColor="Gray" />
                                                <Picker ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=AddTransactionViewModel.Model.AvailableCategories}"
                                                        ItemDisplayBinding="{Binding Name}"
                                                        SelectedItem="{Binding Model.SelectedCategory}"
                                                        BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                            </VerticalStackLayout>

                                            <VerticalStackLayout Grid.Column="1"
                                                                 Spacing="4">
                                                <Label Text="Amount"
                                                       FontSize="12"
                                                       TextColor="Gray" />
                                                <Entry Text="{Binding Model.Amount}"
                                                       Placeholder="0.00"
                                                       Keyboard="Numeric"
                                                       PlaceholderColor="Gray"
                                                       BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                                       WidthRequest="120" />
                                            </VerticalStackLayout>

                                            <Button Grid.Column="2"
                                                    Text="ðŸ—‘ï¸"
                                                    FontSize="18"
                                                    Padding="8"
                                                    VerticalOptions="End"
                                                    BackgroundColor="#DC3545"
                                                    TextColor="White"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=AddTransactionViewModel.RemoveSplitCommand}"
                                                    CommandParameter="{Binding .}"
                                                    IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=AddTransactionViewModel.Model.Splits.Count, Converter={StaticResource GreaterThanOneConverter}}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <Button Text="âž• Add Split"
                                Command="{Binding AddTransactionViewModel.AddSplitCommand}"
                                BackgroundColor="#28A745"
                                TextColor="White" />

                        <HorizontalStackLayout Spacing="4">
                            <Label Text="Balance:"
                                   TextColor="Gray"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding AddTransactionViewModel.Model.RemainingAmount, StringFormat='{0:C}'}"
                                   TextColor="{Binding AddTransactionViewModel.Model.AreSplitsBalanced, Converter={StaticResource BalanceColorConverter}}"
                                   FontAttributes="Bold" />
                            <Label Text="remaining"
                                   TextColor="Gray" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!-- Memo Entry -->
                    <VerticalStackLayout Spacing="4">
                        <Label Text="Memo (Optional)"
                               FontAttributes="Bold" />
                        <Editor Text="{Binding AddTransactionViewModel.Model.Memo}"
                                Placeholder="Add a note..."
                                HeightRequest="80"
                                PlaceholderColor="Gray"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                    </VerticalStackLayout>

                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*"
                          ColumnSpacing="12"
                          Margin="0,8,0,0">
                        <Button Grid.Column="0"
                                Text="Cancel"
                                Command="{Binding CancelAddTransactionCommand}"
                                BackgroundColor="Gray"
                                TextColor="White" />
                        <Button Grid.Column="1"
                                Text="Create Transaction"
                                Command="{Binding SaveTransactionInlineCommand}"
                                BackgroundColor="#28A745"
                                TextColor="White"
                                IsEnabled="{Binding AddTransactionViewModel.Model.IsBusy, Converter={StaticResource InvertedBoolConverter}}" />
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- Inline Edit Transaction Form (with Splits Management) -->
            <!-- This section has been removed - edit is now inline within each transaction -->

            <!-- Inline Edit Transaction Split Form -->
            <!-- This section has been removed - splits are now edited inline within the transaction edit form -->

            <!-- Inline Add Split to Transaction Form -->
            <!-- This section has been removed - splits are now added inline within the transaction edit form -->

            <!-- Transactions List Section -->
            <VerticalStackLayout Spacing="12"
                                 IsVisible="{Binding Model.IsLoggedIn}">
                <Label Text="ðŸ“‹ Transactions"
                       FontSize="20"
                       FontAttributes="Bold"
                       Margin="0,8,0,0" />

                <CollectionView ItemsSource="{Binding Model.Items}">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="32"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Spacing="12">
                            <Label Text="ðŸ“„"
                                   FontSize="48"
                                   HorizontalOptions="Center" />
                            <Label Text="No transactions found."
                                   FontSize="16"
                                   TextColor="Gray"
                                   HorizontalOptions="Center" />
                            <Label Text="Click &quot;New Transaction&quot; to add your first transaction."
                                   FontSize="14"
                                   TextColor="Gray"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="local:TransactionItem">
                            <VerticalStackLayout Spacing="4"
                                                 Margin="0,4">
                                
                                <!-- Inline Edit Form (shown when this transaction is being edited) -->
                                <Border Padding="16"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                        Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 12">
                                    <Border.IsVisible>
                                        <MultiBinding Converter="{StaticResource IsEditingTransactionConverter}">
                                            <Binding Path="Id" />
                                            <Binding Source="{RelativeSource AncestorType={x:Type local:TransactionsViewModel}}" Path="EditingTransactionId" />
                                        </MultiBinding>
                                    </Border.IsVisible>

                                    <VerticalStackLayout Spacing="12">
                                        <!-- Transaction Fields in Grid Layout matching the design image -->
                                        <Grid ColumnDefinitions="*,*,*,Auto"
                                              ColumnSpacing="12"
                                              RowSpacing="8">
                                            
                                            <!-- Date -->
                                            <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                <Label Text="Date" FontAttributes="Bold" FontSize="12" />
                                                <DatePicker Date="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.TransactionDate}"
                                                            BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                            </VerticalStackLayout>

                                            <!-- Payee -->
                                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                                <Label Text="Payee" FontAttributes="Bold" FontSize="12" />
                                                <Entry Text="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.Payee}"
                                                       BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                            </VerticalStackLayout>

                                            <!-- Account -->
                                            <VerticalStackLayout Grid.Column="2" Spacing="4">
                                                <Label Text="Account" FontAttributes="Bold" FontSize="12" />
                                                <Picker ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.AvailableAccounts}"
                                                        ItemDisplayBinding="{Binding AccountName}"
                                                        SelectedItem="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.SelectedAccount}"
                                                        BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                            </VerticalStackLayout>

                                            <!-- Amount -->
                                            <VerticalStackLayout Grid.Column="3" Spacing="4">
                                                <Label Text="Amount" FontAttributes="Bold" FontSize="12" />
                                                <Entry Text="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.Amount}"
                                                       Keyboard="Numeric"
                                                       WidthRequest="120"
                                                       BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                            </VerticalStackLayout>
                                        </Grid>

                                        <!-- Memo field on separate row -->
                                        <VerticalStackLayout Spacing="4">
                                            <Label Text="Memo" FontAttributes="Bold" FontSize="12" />
                                            <Entry Text="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.Description}"
                                                   BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
                                        </VerticalStackLayout>

                                        <!-- Splits Section -->
                                        <VerticalStackLayout Spacing="8" Margin="0,8,0,0">
                                            <HorizontalStackLayout Spacing="8">
                                                <Label Text="Splits"
                                                       FontAttributes="Bold"
                                                       FontSize="14"
                                                       VerticalOptions="Center" />
                                                <Label Text="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.TransactionDate, StringFormat='(for {0:MMMM yyyy})'}"
                                                       FontSize="12"
                                                       TextColor="Gray"
                                                       VerticalOptions="Center" />
                                                <Button Text="âž• Add Split"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.AddSplitCommand}"
                                                        BackgroundColor="#28A745"
                                                        TextColor="White"
                                                        FontSize="12"
                                                        Padding="8,4" />
                                            </HorizontalStackLayout>
                                            
                                            <!-- Editable Splits List -->
                                            <CollectionView ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.Splits}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="local:EditableSplitItem">
                                                        <VerticalStackLayout Spacing="4">
                                                            <Border Padding="8"
                                                                    Margin="0,4"
                                                                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                                    StrokeThickness="1"
                                                                    StrokeShape="RoundRectangle 6">
                                                                <Grid ColumnDefinitions="*,Auto,Auto"
                                                                      ColumnSpacing="8">
                                                                    
                                                                    <!-- Category Picker -->
                                                                    <Picker Grid.Column="0"
                                                                            ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.Model.AvailableCategories}"
                                                                            ItemDisplayBinding="{Binding Name}"
                                                                            SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                                                                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                                            VerticalOptions="Center" />

                                                                    <!-- Amount Entry -->
                                                                    <Entry Grid.Column="1"
                                                                           Text="{Binding Amount}"
                                                                           Placeholder="0.00"
                                                                           Keyboard="Numeric"
                                                                           WidthRequest="100"
                                                                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                                           VerticalOptions="Center" />
                                                                    
                                                                    <!-- Delete Button -->
                                                                    <Button Grid.Column="2"
                                                                            Text="ðŸ—‘ï¸"
                                                                            FontSize="14"
                                                                            Padding="8,4"
                                                                            BackgroundColor="#DC3545"
                                                                            TextColor="White"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=EditTransactionViewModel.DeleteSplitCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            VerticalOptions="Center" />
                                                                </Grid>
                                                            </Border>
                                                            
                                                            <!-- Notes field below each split -->
                                                            <Entry Text="{Binding Description}"
                                                                   Placeholder="Notes (optional)"
                                                                   Margin="0,0,0,4"
                                                                   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                                                        </VerticalStackLayout>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </VerticalStackLayout>

                                        <!-- Action Buttons -->
                                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                                            <Button Text="Cancel"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=CancelEditTransactionCommand}"
                                                    BackgroundColor="Gray"
                                                    TextColor="White" />
                                            <Button Grid.Column="1"
                                                    Text="Save Transaction"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=SaveEditTransactionCommand}"
                                                    BackgroundColor="#28A745"
                                                    TextColor="White" />
                                        </Grid>
                                    </VerticalStackLayout>
                                </Border>

                                <!-- Read-Only View (hidden when editing) -->
                                <VerticalStackLayout Spacing="0">
                                    <VerticalStackLayout.IsVisible>
                                        <MultiBinding Converter="{StaticResource IsNotEditingTransactionConverter}">
                                            <Binding Path="Id" />
                                            <Binding Source="{RelativeSource AncestorType={x:Type local:TransactionsViewModel}}" Path="EditingTransactionId" />
                                        </MultiBinding>
                                    </VerticalStackLayout.IsVisible>

                                <!-- Read-Only Transaction Row -->
                                <Border Padding="16"
                                        BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                        Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 12">
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto"
                                          RowDefinitions="Auto,Auto"
                                          ColumnSpacing="12"
                                          RowSpacing="8">
                                        <!-- Date -->
                                        <Label Grid.Column="0"
                                               Text="{Binding Date, StringFormat='{0:MM/dd/yyyy}'}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                               VerticalOptions="Center" />

                                        <!-- Payee and Account -->
                                        <VerticalStackLayout Grid.Column="1"
                                                             Spacing="2">
                                            <Label Text="{Binding Payee}"
                                                   FontSize="16"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding AccountName}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                   FontAttributes="Italic" />
                                        </VerticalStackLayout>

                                        <!-- Amount -->
                                        <Label Grid.Column="2"
                                               Text="{Binding Amount, StringFormat='{0:C}'}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextColor="{Binding Amount, Converter={StaticResource AmountColorConverter}}"
                                               VerticalOptions="Center"
                                               HorizontalOptions="End" />

                                        <!-- Action Buttons -->
                                        <Button Grid.Column="3"
                                                Text="âœï¸"
                                                FontSize="16"
                                                Padding="8"
                                                BackgroundColor="#28A745"
                                                TextColor="White"
                                                ToolTipProperties.Text="Edit Transaction"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=ModifyTransactionCommand}"
                                                CommandParameter="{Binding Id}" />
                                        <Button Grid.Column="4"
                                                Text="ðŸ—‘ï¸"
                                                FontSize="16"
                                                Padding="8"
                                                BackgroundColor="#DC3545"
                                                TextColor="White"
                                                ToolTipProperties.Text="Delete Transaction"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:TransactionsViewModel}}, Path=DeleteTransactionCommand}"
                                                CommandParameter="{Binding Id}" />
                                    </Grid>
                                </Border>

                                <!-- Read-Only Split Rows (indented) -->
                                <VerticalStackLayout Margin="24,0,0,0"
                                                     Spacing="4">
                                    <CollectionView ItemsSource="{Binding Splits}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="dto:TransactionSplitResponse">
                                                <Border Padding="12"
                                                        Margin="0,4"
                                                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                        Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                                        StrokeThickness="1"
                                                        StrokeShape="RoundRectangle 6">
                                                    <Grid ColumnDefinitions="Auto,*,Auto"
                                                          RowDefinitions="Auto,Auto"
                                                          ColumnSpacing="8"
                                                          RowSpacing="4">
                                                        <!-- Split indicator -->
                                                        <Label Grid.Column="0"
                                                               Text="â†³"
                                                               FontSize="16"
                                                               TextColor="Gray"
                                                               VerticalOptions="Start" />

                                                        <!-- Category -->
                                                        <Label Grid.Column="1"
                                                               Text="{Binding CategoryName}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               VerticalOptions="Center" />

                                                        <!-- Amount -->
                                                        <Label Grid.Column="2"
                                                               Text="{Binding Amount, StringFormat='{0:C}'}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="{Binding Amount, Converter={StaticResource AmountColorConverter}}"
                                                               HorizontalOptions="End"
                                                               VerticalOptions="Center" />

                                                        <!-- Description on second row -->
                                                        <Label Grid.Row="1"
                                                               Grid.Column="1"
                                                               Grid.ColumnSpan="2"
                                                               Text="{Binding Description}"
                                                               FontSize="12"
                                                               TextColor="Gray"
                                                               IsVisible="{Binding Description, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                                </VerticalStackLayout> <!-- Close Read-Only View -->
                            </VerticalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
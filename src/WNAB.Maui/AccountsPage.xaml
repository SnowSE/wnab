<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WNAB.MVM;assembly=WNAB.MVM"
             xmlns:converters="clr-namespace:WNAB.Maui.Converters;assembly=WNAB.Maui"
             x:Class="WNAB.Maui.AccountsPage"
             x:DataType="vm:AccountsViewModel"
             Title="Accounts">

    <ScrollView>
        <VerticalStackLayout Spacing="24">
            <VerticalStackLayout.Padding>
                <OnIdiom x:TypeArguments="Thickness"
                         Phone="12"
                         Tablet="20"
                         Desktop="24" />
            </VerticalStackLayout.Padding>
            <VerticalStackLayout.Spacing>
                <OnIdiom x:TypeArguments="x:Double"
                         Phone="16"
                         Tablet="20"
                         Desktop="24" />
            </VerticalStackLayout.Spacing>

            <!-- Header with title and Add Account button -->
            <Grid ColumnDefinitions="*,Auto,Auto"
                  ColumnSpacing="12">
                <VerticalStackLayout Spacing="4">
                    <Label>
                        <Label.FontSize>
                            <OnIdiom x:TypeArguments="x:Double"
                                     Phone="12"
                                     Tablet="13"
                                     Desktop="14" />
                        </Label.FontSize>
                        <Label.Text>
                            <Binding Path="Model.ShowInactive">
                                <Binding.Converter>
                                    <converters:BoolToTextConverter TrueText="Viewing inactive accounts"
                                                                    FalseText="Manage your financial accounts" />
                                </Binding.Converter>
                            </Binding>
                        </Label.Text>
                    </Label>
                </VerticalStackLayout>

                <Button Grid.Column="1"
                        Command="{Binding AddAccountCommand}"
                        IsEnabled="{Binding Model.IsLoggedIn}"
                        IsVisible="{Binding Model.ShowInactive, Converter={StaticResource InvertedBoolConverter}}"
                        CornerRadius="8"
                        VerticalOptions="Center">
                    <Button.Text>
                        <OnIdiom x:TypeArguments="x:String"
                                 Phone="+ Add"
                                 Tablet="+ Add Account"
                                 Desktop="+ Add Account" />
                    </Button.Text>
                    <Button.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="12,8"
                                 Tablet="14,10"
                                 Desktop="16,12" />
                    </Button.Padding>
                </Button>

                <Button Grid.Column="2"
                        Command="{Binding ToggleShowInactiveCommand}"
                        IsEnabled="{Binding Model.IsLoggedIn}"
                        CornerRadius="8"
                        VerticalOptions="Center">
                    <Button.Text>
                        <Binding Path="Model.ShowInactive">
                            <Binding.Converter>
                                <converters:BoolToTextConverter TrueText="Show Active"
                                                                FalseText="Show Inactive" />
                            </Binding.Converter>
                        </Binding>
                    </Button.Text>
                    <Button.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="8,6"
                                 Tablet="10,8"
                                 Desktop="12,10" />
                    </Button.Padding>
                </Button>
            </Grid>

            <!-- Login prompt when not logged in -->
            <Label Text="Please use the Login page to sign in first."
                   IsVisible="{Binding Model.IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                   HorizontalOptions="Center"
                   Margin="0,20" />

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding Model.IsBusy}"
                               IsVisible="{Binding Model.IsBusy}" />

            <!-- Content when logged in -->
            <VerticalStackLayout Spacing="24"
                                 IsVisible="{Binding Model.IsLoggedIn}">

                <!-- Total Balance Card -->
                <Border StrokeThickness="1"
                        Shadow="{Shadow Brush=Gray, Offset='2,2', Radius=4, Opacity=0.2}">
                    <Border.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="16"
                                 Tablet="20"
                                 Desktop="24" />
                    </Border.Padding>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Total Balance">
                            <Label.FontSize>
                                <OnIdiom x:TypeArguments="x:Double"
                                         Phone="12"
                                         Tablet="13"
                                         Desktop="14" />
                            </Label.FontSize>
                        </Label>
                        <Label FontAttributes="Bold">
                            <Label.FontSize>
                                <OnIdiom x:TypeArguments="x:Double"
                                         Phone="28"
                                         Tablet="32"
                                         Desktop="36" />
                            </Label.FontSize>
                            <Label.Text>
                                <Binding Path="Model.Items">
                                    <Binding.Converter>
                                        <converters:TotalBalanceConverter />
                                    </Binding.Converter>
                                </Binding>
                            </Label.Text>
                        </Label>
                    </VerticalStackLayout>
                </Border>

                <!-- Active Accounts presented with a responsive grid to prevent overlap -->
                <CollectionView x:Name="AccountsCollection"
                                ItemsSource="{Binding Model.Items}"
                                IsVisible="{Binding Model.ShowInactive, Converter={StaticResource InvertedBoolConverter}}"
                                SelectionMode="None"
                                HorizontalScrollBarVisibility="Never"
                                VerticalScrollBarVisibility="Default"
                                ItemSizingStrategy="MeasureFirstItem">
                    <CollectionView.ItemsLayout>
                        <!-- Span is set dynamically in code-behind based on available width -->
                        <GridItemsLayout Orientation="Vertical"
                                         Span="1"
                                         HorizontalItemSpacing="12"
                                         VerticalItemSpacing="12" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.EmptyView>
                        <Label Text="No accounts found."
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Margin="0,40" />
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:AccountItemViewModel">
                            <Border StrokeThickness="1"
                                    Shadow="{Shadow Brush=Gray, Offset='2,2', Radius=4, Opacity=0.2}"
                                    Margin="0"
                                    HorizontalOptions="FillAndExpand">
                                <Border.Padding>
                                    <OnIdiom x:TypeArguments="Thickness"
                                             Phone="12"
                                             Tablet="16"
                                             Desktop="20" />
                                </Border.Padding>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Grid RowDefinitions="Auto,Auto,Auto">
                                    <Grid.RowSpacing>
                                        <OnIdiom x:TypeArguments="x:Double"
                                                 Phone="12"
                                                 Tablet="14"
                                                 Desktop="16" />
                                    </Grid.RowSpacing>

                                    <!-- Account Name with Edit/Delete buttons (View Mode) -->
                                    <Grid ColumnDefinitions="*,Auto,Auto"
                                          ColumnSpacing="8"
                                          IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                                        <Label Text="{Binding AccountName}"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="14"
                                                         Tablet="15"
                                                         Desktop="16" />
                                            </Label.FontSize>
                                        </Label>
                                        <Label Grid.Column="1"
                                               Text="âœï¸"
                                               VerticalOptions="Center">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="16"
                                                         Tablet="17"
                                                         Desktop="18" />
                                            </Label.FontSize>
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=EditAccountCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        <Label Grid.Column="2"
                                               Text="ðŸ—‘ï¸"
                                               VerticalOptions="Center">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="16"
                                                         Tablet="17"
                                                         Desktop="18" />
                                            </Label.FontSize>
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=DeactivateAccountCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>

                                    <!-- Account Name Edit Mode (with Save/Cancel) -->
                                    <Grid ColumnDefinitions="*,Auto,Auto"
                                          ColumnSpacing="8"
                                          IsVisible="{Binding IsEditing}">
                                        <Entry Text="{Binding EditAccountName}"
                                               VerticalOptions="Center"
                                               Placeholder="Account Name">
                                            <Entry.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="12"
                                                         Tablet="13"
                                                         Desktop="14" />
                                            </Entry.FontSize>
                                            <Entry.HeightRequest>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="36"
                                                         Tablet="38"
                                                         Desktop="40" />
                                            </Entry.HeightRequest>
                                        </Entry>
                                        <Label Grid.Column="1"
                                               Text="âœ…"
                                               VerticalOptions="Center">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="16"
                                                         Tablet="17"
                                                         Desktop="18" />
                                            </Label.FontSize>
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=SaveAccountCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        <Label Grid.Column="2"
                                               Text="âŒ"
                                               VerticalOptions="Center">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="16"
                                                         Tablet="17"
                                                         Desktop="18" />
                                            </Label.FontSize>
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=CancelEditAccountCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>

                                    <!-- Account Type Badge (View Mode) -->
                                    <HorizontalStackLayout Grid.Row="1"
                                                           Spacing="8"
                                                           IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                                        <Border Stroke="Transparent">
                                            <Border.Padding>
                                                <OnIdiom x:TypeArguments="Thickness"
                                                         Phone="8,4"
                                                         Tablet="10,5"
                                                         Desktop="12,6" />
                                            </Border.Padding>
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="ðŸ’³">
                                                    <Label.FontSize>
                                                        <OnIdiom x:TypeArguments="x:Double"
                                                                 Phone="12"
                                                                 Tablet="13"
                                                                 Desktop="14" />
                                                    </Label.FontSize>
                                                </Label>
                                                <Label Text="{Binding AccountTypeDisplay}">
                                                    <Label.FontSize>
                                                        <OnIdiom x:TypeArguments="x:Double"
                                                                 Phone="11"
                                                                 Tablet="11.5"
                                                                 Desktop="12" />
                                                    </Label.FontSize>
                                                </Label>
                                            </HorizontalStackLayout>
                                        </Border>
                                    </HorizontalStackLayout>

                                    <!-- Account Type Edit Mode -->
                                    <Picker Grid.Row="1"
                                            SelectedItem="{Binding EditAccountTypeString}"
                                            VerticalOptions="Center"
                                            IsVisible="{Binding IsEditing}">
                                        <Picker.FontSize>
                                            <OnIdiom x:TypeArguments="x:Double"
                                                     Phone="12"
                                                     Tablet="13"
                                                     Desktop="14" />
                                        </Picker.FontSize>
                                        <Picker.HeightRequest>
                                            <OnIdiom x:TypeArguments="x:Double"
                                                     Phone="36"
                                                     Tablet="38"
                                                     Desktop="40" />
                                        </Picker.HeightRequest>
                                        <Picker.ItemsSource>
                                            <x:Array Type="{x:Type x:String}">
                                                <x:String>Checking</x:String>
                                                <x:String>Savings</x:String>
                                                <x:String>Misc</x:String>
                                            </x:Array>
                                        </Picker.ItemsSource>
                                    </Picker>

                                    <!-- Balance -->
                                    <VerticalStackLayout Grid.Row="2"
                                                         Spacing="4">
                                        <Label Text="{Binding CachedBalance, StringFormat='{0:C}'}"
                                               FontAttributes="Bold">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="20"
                                                         Tablet="22"
                                                         Desktop="24" />
                                            </Label.FontSize>
                                        </Label>
                                        <Label Text="USD">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="10"
                                                         Tablet="11"
                                                         Desktop="12" />
                                            </Label.FontSize>
                                        </Label>
                                    </VerticalStackLayout>

                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Inactive Accounts presented with a responsive grid -->
                <CollectionView x:Name="InactiveAccountsCollection"
                                ItemsSource="{Binding Model.InactiveItems}"
                                IsVisible="{Binding Model.ShowInactive}"
                                SelectionMode="None"
                                HorizontalScrollBarVisibility="Never"
                                VerticalScrollBarVisibility="Default"
                                ItemSizingStrategy="MeasureFirstItem">
                    <CollectionView.ItemsLayout>
                        <!-- Span is set dynamically in code-behind based on available width -->
                        <GridItemsLayout Orientation="Vertical"
                                         Span="1"
                                         HorizontalItemSpacing="12"
                                         VerticalItemSpacing="12" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Spacing="12"
                                             Margin="0,40">
                            <Label Text="ðŸ“­"
                                   HorizontalOptions="Center"
                                   FontSize="48" />
                            <Label Text="No inactive accounts to show"
                                   HorizontalOptions="Center"
                                   FontSize="16"
                                   FontAttributes="Bold" />
                            <Label Text="Deactivated accounts will appear here"
                                   HorizontalOptions="Center"
                                   FontSize="14"
                                   TextColor="Gray" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:AccountItemViewModel">
                            <Border StrokeThickness="1"
                                    Shadow="{Shadow Brush=Gray, Offset='2,2', Radius=4, Opacity=0.2}"
                                    Margin="0"
                                    HorizontalOptions="FillAndExpand"
                                    Opacity="0.7">
                                <Border.Padding>
                                    <OnIdiom x:TypeArguments="Thickness"
                                             Phone="12"
                                             Tablet="16"
                                             Desktop="20" />
                                </Border.Padding>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Grid RowDefinitions="Auto,Auto,Auto">
                                    <Grid.RowSpacing>
                                        <OnIdiom x:TypeArguments="x:Double"
                                                 Phone="12"
                                                 Tablet="14"
                                                 Desktop="16" />
                                    </Grid.RowSpacing>

                                    <!-- Account Name with Reactivate button -->
                                    <Grid ColumnDefinitions="*,Auto"
                                          ColumnSpacing="8">
                                        <Label Text="{Binding AccountName}"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation"
                                               TextDecorations="Strikethrough">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="14"
                                                         Tablet="15"
                                                         Desktop="16" />
                                            </Label.FontSize>
                                        </Label>
                                        <HorizontalStackLayout Grid.Column="1"
                                                               Spacing="6"
                                                               VerticalOptions="Center">
                                            <Label Text="â™»ï¸">
                                                <Label.FontSize>
                                                    <OnIdiom x:TypeArguments="x:Double"
                                                             Phone="16"
                                                             Tablet="17"
                                                             Desktop="18" />
                                                </Label.FontSize>
                                            </Label>
                                            <Label Text="Reactivate Account"
                                                   VerticalOptions="Center">
                                                <Label.FontSize>
                                                    <OnIdiom x:TypeArguments="x:Double"
                                                             Phone="12"
                                                             Tablet="13"
                                                             Desktop="14" />
                                                </Label.FontSize>
                                            </Label>
                                            <HorizontalStackLayout.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=ReactivateAccountCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </HorizontalStackLayout.GestureRecognizers>
                                        </HorizontalStackLayout>
                                    </Grid>

                                    <!-- Account Type Badge -->
                                    <HorizontalStackLayout Grid.Row="1"
                                                           Spacing="8">
                                        <Border Stroke="Transparent"
                                                Opacity="0.8">
                                            <Border.Padding>
                                                <OnIdiom x:TypeArguments="Thickness"
                                                         Phone="8,4"
                                                         Tablet="10,5"
                                                         Desktop="12,6" />
                                            </Border.Padding>
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="ðŸ’³">
                                                    <Label.FontSize>
                                                        <OnIdiom x:TypeArguments="x:Double"
                                                                 Phone="12"
                                                                 Tablet="13"
                                                                 Desktop="14" />
                                                    </Label.FontSize>
                                                </Label>
                                                <Label Text="{Binding AccountTypeDisplay}">
                                                    <Label.FontSize>
                                                        <OnIdiom x:TypeArguments="x:Double"
                                                                 Phone="11"
                                                                 Tablet="11.5"
                                                                 Desktop="12" />
                                                    </Label.FontSize>
                                                </Label>
                                            </HorizontalStackLayout>
                                        </Border>
                                        <Label Text="(Inactive)"
                                               TextColor="Gray"
                                               VerticalOptions="Center">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="11"
                                                         Tablet="11.5"
                                                         Desktop="12" />
                                            </Label.FontSize>
                                        </Label>
                                    </HorizontalStackLayout>

                                    <!-- Balance -->
                                    <VerticalStackLayout Grid.Row="2"
                                                         Spacing="4">
                                        <Label Text="{Binding CachedBalance, StringFormat='{0:C}'}"
                                               FontAttributes="Bold">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="20"
                                                         Tablet="22"
                                                         Desktop="24" />
                                            </Label.FontSize>
                                        </Label>
                                        <Label Text="USD">
                                            <Label.FontSize>
                                                <OnIdiom x:TypeArguments="x:Double"
                                                         Phone="10"
                                                         Tablet="11"
                                                         Desktop="12" />
                                            </Label.FontSize>
                                        </Label>
                                    </VerticalStackLayout>

                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
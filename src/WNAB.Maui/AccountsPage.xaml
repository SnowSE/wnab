<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WNAB.MVM;assembly=WNAB.MVM"
             xmlns:converters="clr-namespace:WNAB.Maui.Converters"
             x:Class="WNAB.Maui.AccountsPage"
             x:DataType="vm:AccountsViewModel"
             Title="Accounts">
    
    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="24">
            
            <!-- Header with title and Add Account button -->
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16">
                <VerticalStackLayout Spacing="4">
                    <Label Text="Accounts" 
                           FontSize="28" 
                           FontAttributes="Bold" />
                    <Label Text="Manage your financial accounts" 
                           FontSize="14" 
                           />
                </VerticalStackLayout>
                
                <Button Grid.Column="1" 
                        Text="+ Add Account"
                        Command="{Binding AddAccountCommand}"
                        IsEnabled="{Binding Model.IsLoggedIn}"
                        CornerRadius="8"
                        Padding="16,12"
                        VerticalOptions="Center" />
            </Grid>

            <!-- Login prompt when not logged in -->
            <Label Text="Please use the Login page to sign in first." 
                   IsVisible="{Binding Model.IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                   HorizontalOptions="Center" 
                   Margin="0,20" />

            <!-- Loading indicator -->
            <ActivityIndicator IsRunning="{Binding Model.IsBusy}" 
                             IsVisible="{Binding Model.IsBusy}" />
            
            <!-- Content when logged in -->
            <VerticalStackLayout Spacing="24" IsVisible="{Binding Model.IsLoggedIn}">
                
                <!-- Total Balance Card -->
                <Border StrokeThickness="1"
                        Padding="24"
                        Shadow="{Shadow Brush=Gray, Offset='2,2', Radius=4, Opacity=0.2}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Total Balance" 
                               FontSize="14" 
                                />
                        <Label FontSize="36" 
                               FontAttributes="Bold">
                            <Label.Text>
                                <Binding Path="Model.Items">
                                    <Binding.Converter>
                                        <converters:TotalBalanceConverter />
                                    </Binding.Converter>
                                </Binding>
                            </Label.Text>
                        </Label>
                    </VerticalStackLayout>
                </Border>

                <!-- Accounts Grid/List -->
                <CollectionView ItemsSource="{Binding Model.Items}">
                    <CollectionView.EmptyView>
                        <Label Text="No accounts found." 
                               HorizontalOptions="Center" 
                               VerticalOptions="Center"
                               Margin="0,40" />
                    </CollectionView.EmptyView>
                    
                    <!-- Responsive Layout: Grid on larger screens, Stack on phones -->
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                       HorizontalItemSpacing="16"
                                       VerticalItemSpacing="16">
                            <GridItemsLayout.Span>
                                <OnIdiom x:TypeArguments="x:Int32" 
                                       Phone="1" 
                                       Tablet="2" 
                                       Desktop="3" />
                            </GridItemsLayout.Span>
                        </GridItemsLayout>
                    </CollectionView.ItemsLayout>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:AccountItemViewModel">
                            <Border StrokeThickness="1"
                                    Padding="20"
                                    Shadow="{Shadow Brush=Gray, Offset='2,2', Radius=4, Opacity=0.2}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Grid RowDefinitions="Auto,*,Auto" 
                                      RowSpacing="12">
                                    
                                    <!-- Account Name with Edit/Delete buttons (View Mode) -->
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8"
                                          IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                                        <Label Text="{Binding AccountName}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"
                                               VerticalOptions="Center" />
                                        <Label Grid.Column="1"
                                               Text="âœï¸"
                                               FontSize="18"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=EditAccountCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        <Label Grid.Column="2"
                                               Text="ðŸ—‘ï¸"
                                               FontSize="18"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>
                                    
                                    <!-- Account Name Edit Mode (with Save/Cancel) -->
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8"
                                          IsVisible="{Binding IsEditing}">
                                        <Entry Text="{Binding EditAccountName}" 
                                               FontSize="16" 
                                               VerticalOptions="Center"
                                               Placeholder="Account Name" />
                                        <Label Grid.Column="1"
                                               Text="âœ…"
                                               FontSize="18"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=SaveAccountCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                        <Label Grid.Column="2"
                                               Text="âŒ"
                                               FontSize="18"
                                               VerticalOptions="Center">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountsViewModel}}, Path=CancelEditAccountCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>
                                    
                                    <!-- Account Type Badge (View Mode) -->
                                    <HorizontalStackLayout Grid.Row="1" Spacing="8"
                                                          IsVisible="{Binding IsEditing, Converter={StaticResource InvertedBoolConverter}}">
                                        <Border Stroke="Transparent"
                                                Padding="12,6">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="6" />
                                            </Border.StrokeShape>
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="ðŸ’³" FontSize="14" />
                                                <Label Text="{Binding AccountTypeDisplay}" 
                                                       FontSize="12" />
                                            </HorizontalStackLayout>
                                        </Border>
                                    </HorizontalStackLayout>
                                    
                                    <!-- Account Type Edit Mode -->
                                    <Picker Grid.Row="1" 
                                            SelectedItem="{Binding EditAccountTypeString}"
                                            FontSize="14"
                                            IsVisible="{Binding IsEditing}">
                                        <Picker.ItemsSource>
                                            <x:Array Type="{x:Type x:String}">
                                                <x:String>Checking</x:String>
                                                <x:String>Savings</x:String>
                                                <x:String>Misc</x:String>
                                            </x:Array>
                                        </Picker.ItemsSource>
                                    </Picker>
                                    
                                    <!-- Balance -->
                                    <VerticalStackLayout Grid.Row="2" Spacing="4">
                                        <Label Text="{Binding CachedBalance, StringFormat='{0:C}'}" 
                                               FontSize="24" 
                                               FontAttributes="Bold" />
                                        <Label Text="USD" 
                                               FontSize="12" 
                                                />
                                    </VerticalStackLayout>
                                    
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
            </VerticalStackLayout>
            
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
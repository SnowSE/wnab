<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:WNAB.MVM;assembly=WNAB.MVM"
             xmlns:data="clr-namespace:WNAB.Data;assembly=WNAB.Data"
             x:Class="WNAB.Maui.MainPage"
             x:DataType="local:PlanBudgetViewModel"
             Title="Monthly Budget">

    <!-- LLM-Dev: MainPage is now the Budgets page, following the design pattern from Web -->
    


    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">
            
            <!-- Toolbar buttons at top of page -->
            <HorizontalStackLayout Spacing="12" HorizontalOptions="End">
                <Button Text="Edit Budget"
                        IsVisible="{Binding Model.IsEditMode, Converter={StaticResource InvertedBoolConverter}}"
                        Command="{Binding ToggleEditModeCommand}"
                        CornerRadius="8"
                        VerticalOptions="Center">
                    <Button.Padding>
                        <OnIdiom x:TypeArguments="Thickness"
                                 Phone="12,8"
                                 Tablet="14,10"
                                 Desktop="16,12" />
                    </Button.Padding>
                </Button>
                <Button Text="Cancel"
                        IsVisible="{Binding Model.IsEditMode}"
                        Command="{Binding UndoChangesCommand}"
                        BackgroundColor="{AppThemeBinding Light=#DC3545, Dark=#DC3545}"
                        TextColor="White"
                        WidthRequest="100" />
                <Button Text="Save Changes"
                        IsVisible="{Binding Model.IsEditMode}"
                        Command="{Binding SaveCommand}"
                        BackgroundColor="{AppThemeBinding Light=#28A745, Dark=#28A745}"
                        TextColor="White"
                        WidthRequest="130" />
            </HorizontalStackLayout>

            <!-- Compact Month Navigator -->
            <Border Padding="12"
                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray900}}"
                    HorizontalOptions="Center">
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                    <!-- Previous Month Button -->
                    <Button Grid.Column="0"
                            Text="&lt;"
                            Command="{Binding PreviousMonthCommand}"
                            IsEnabled="{Binding Model.IsEditMode, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                            FontSize="20"
                            WidthRequest="40"
                            HeightRequest="40"/>
                    
                    <!-- Month/Year Display (tappable) -->
                    <Border Grid.Column="1"
                            Padding="12,8"
                            BackgroundColor="Transparent"
                            StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnMonthYearDisplayTapped"/>
                        </Border.GestureRecognizers>
                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                            <Label Text="{Binding CurrentMonthAbbreviation}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding Model.CurrentYear}"
                                   FontSize="18"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                   VerticalOptions="Center"/>
                            <Label Text="▼"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>
                    
                    <!-- Next Month Button -->
                    <Button Grid.Column="2"
                            Text="&gt;"
                            Command="{Binding NextMonthCommand}"
                            IsEnabled="{Binding Model.IsEditMode, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                            FontSize="20"
                            WidthRequest="40"
                            HeightRequest="40"/>
                </Grid>
            </Border>

            <!-- Ready to Assign Section -->
            <Border Padding="20"
                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray900}}">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Ready to Assign"
                           FontSize="16"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                    <Label Text="{Binding ReadyToAssignFormatted}"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Category Allocations Section -->
            <Label Text="Category Allocations" FontSize="16" FontAttributes="Bold"/>
            
            <!-- Available Categories Section -->
            <VerticalStackLayout Spacing="10" IsVisible="{Binding Model.IsCategoriesVisible}">
                <Label Text="Available Categories" FontSize="16" FontAttributes="Bold"/>
                <CollectionView ItemsSource="{Binding Model.AvailableCategories}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="data:Category">
                            <Border Padding="15"
                                    Margin="0,5"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray900}}">
                                <HorizontalStackLayout Spacing="10">
                                    <!-- Category Color Dot -->
                                    <BoxView WidthRequest="12"
                                             HeightRequest="12"
                                             CornerRadius="6"
                                             Color="{Binding Color}"
                                             VerticalOptions="Center"/>
                                    <!-- Category Name -->
                                    <Label Text="{Binding Name}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                    <!-- Allocate Button -->
                                    <Button Text="Allocate"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AllocateCategoryCommand}"
                                            CommandParameter="{Binding}"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                            HorizontalOptions="End"/>
                                </HorizontalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
            
            <!-- Login warning -->
            <Border Padding="15"
                    BackgroundColor="{AppThemeBinding Light=#FFF3CD, Dark=#856404}"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light=#FFC107, Dark=#FFC107}"
                    IsVisible="{Binding Model.IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}">
                <HorizontalStackLayout Spacing="10">
                    <Label Text="⚠️" FontSize="18" VerticalOptions="Center"/>
                    <Label Text="Please log in to view budget."
                           VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Border>
            
            <CollectionView ItemsSource="{Binding Model.BudgetAllocations}"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="data:CategoryAllocation">
                        <Border Padding="15"
                                Margin="0,5"
                                BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}"
                                StrokeThickness="1"
                                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray900}}">
                            
                            <VerticalStackLayout Spacing="10">
                                <!-- Category Header -->
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto" RowSpacing="10">
                                    <!-- Category Color Dot -->
                                    <BoxView Grid.Column="0"
                                             WidthRequest="12"
                                             HeightRequest="12"
                                             CornerRadius="6"
                                             Color="{Binding Category.Color}"
                                             VerticalOptions="Center"
                                             Margin="0,0,10,0"/>
                                    
                                    <!-- Category Name -->
                                    <Label Grid.Column="1"
                                           Text="{Binding Category.Name}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"/>
                                    
                                    <!-- Deactivate Button (eye icon) -->
                                    <Button Grid.Column="2"
                                            Text="&#xf070;"
                                            FontFamily="FontAwesomeSolid"
                                            FontSize="16"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            Padding="0"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeactivateAllocationCommand}"
                                            CommandParameter="{Binding}"
                                            ToolTipProperties.Text="Deactivate"
                                            VerticalOptions="Center"
                                            Margin="0,0,8,0"/>
                                    
                                    <!-- Budget Amount (view mode) -->
                                    <Label Grid.Column="3"
                                           Text="{Binding BudgetedAmount, StringFormat='{0:C}'}"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Model.IsEditMode, Converter={StaticResource InvertedBoolConverter}}"/>
                                </Grid>

                                <!-- Budget Amount (edit mode) -->
                                <HorizontalStackLayout Spacing="5" 
                                                      IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Model.IsEditMode}">
                                    <Label Text="Budget: $" VerticalOptions="Center" FontSize="14"/>
                                    <Entry Text="{Binding BudgetedAmount, Mode=TwoWay}"
                                           Keyboard="Numeric"
                                           WidthRequest="120"
                                           HorizontalTextAlignment="End"/>
                                </HorizontalStackLayout>

                                <!-- Activity (Spent) and Available amounts -->
                                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto" ColumnSpacing="10">
                                    <!-- Activity/Spent -->
                                    <VerticalStackLayout Grid.Column="0" Spacing="2">
                                        <Label Text="Activity" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                                        <Label Text="{Binding Activity, StringFormat='{0:C}'}"
                                               FontSize="14"
                                               FontAttributes="Bold"/>
                                    </VerticalStackLayout>
                                    
                                    <!-- Available/Remaining -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="2">
                                        <Label Text="Available" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                                        <Label Text="{Binding Available, StringFormat='{0:C}'}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{Binding Available, Converter={StaticResource AvailableAmountColorConverter}}"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <!-- Progress Bar -->
                                <ProgressBar HeightRequest="8" 
                                             Margin="0,5,0,0"
                                             ProgressColor="{Binding Available, Converter={StaticResource AvailableAmountColorConverter}}">
                                    <ProgressBar.Progress>
                                        <Binding Path="." Converter="{StaticResource AllocationProgressWidthConverter}" />
                                    </ProgressBar.Progress>
                                </ProgressBar>

                                <!-- Overspending warning -->
                                <Label IsVisible="{Binding Available, Converter={StaticResource IsOverspentConverter}}"
                                       Text="⚠️ Over budget"
                                       FontSize="11"
                                       TextColor="Red"
                                       HorizontalOptions="Center"
                                       Margin="0,5,0,0"/>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Empty State -->
            <VerticalStackLayout Spacing="10" 
                                 Padding="20"
                                 IsVisible="{Binding HasNoBudgetAllocations}">
                <Label Text="📅"
                       FontSize="48"
                       HorizontalOptions="Center"/>
                <Label Text="No budget allocations for this month."
                       FontSize="14"
                       HorizontalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                <Label Text="Add categories to get started."
                       FontSize="12"
                       HorizontalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
            </VerticalStackLayout>

            <!-- Inactive Categories Section -->
            <VerticalStackLayout Spacing="5"
                                 Margin="0,20,0,0"
                                 IsVisible="{Binding HasInactiveAllocations}">
                <!-- Header with dropdown toggle -->
                <Border Padding="15,10"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                        StrokeThickness="0">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               FontSize="14"
                               FontAttributes="Bold"
                               VerticalOptions="Center">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Inactive Categories (" />
                                    <Span Text="{Binding Model.InactiveAllocations.Count}" />
                                    <Span Text=")" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Button Grid.Column="1"
                                Text="{Binding IsInactiveCategoriesExpanded, Converter={StaticResource BoolToExpandIconConverter}}"
                                FontSize="20"
                                WidthRequest="40"
                                HeightRequest="40"
                                Padding="0"
                                BackgroundColor="Transparent"
                                Command="{Binding ToggleInactiveCategoriesCommand}"
                                VerticalOptions="Center"/>
                    </Grid>
                </Border>

                <!-- Inactive Categories List -->
                <CollectionView ItemsSource="{Binding Model.InactiveAllocations}"
                                SelectionMode="None"
                                IsVisible="{Binding IsInactiveCategoriesExpanded}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="data:CategoryAllocation">
                            <Border Padding="15,10"
                                    Margin="0,2"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray50}, Dark={StaticResource Gray900}}"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}">
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                    <!-- Category Color Dot (grayed out) -->
                                    <BoxView Grid.Column="0"
                                             WidthRequest="12"
                                             HeightRequest="12"
                                             CornerRadius="6"
                                             Color="{Binding Category.Color}"
                                             Opacity="0.4"
                                             VerticalOptions="Center"
                                             Margin="0,0,10,0"/>
                                    
                                    <!-- Category Name (grayed out) -->
                                    <Label Grid.Column="1"
                                           Text="{Binding Category.Name}"
                                           FontSize="14"
                                           Opacity="0.6"
                                           VerticalOptions="Center"/>
                                    
                                    <!-- Budget Amount (grayed out) -->
                                    <Label Grid.Column="2"
                                           Text="{Binding BudgetedAmount, StringFormat='{0:C}'}"
                                           FontSize="14"
                                           Opacity="0.5"
                                           Margin="0,0,10,0"
                                           VerticalOptions="Center"/>
                                    
                                    <!-- Activate Button -->
                                    <Button Grid.Column="3"
                                            Text="Activate"
                                            FontSize="12"
                                            Padding="10,5"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                            TextColor="White"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ActivateAllocationCommand}"
                                            CommandParameter="{Binding}"
                                            VerticalOptions="Center"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

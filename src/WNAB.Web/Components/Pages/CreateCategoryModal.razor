@using WNAB.MVM
@inject AddCategoryViewModel ViewModel
@implements IDisposable

<!-- Create Category Modal -->
<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCategoryModalLabel">Create Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <EditForm Model="ViewModel.Model" OnValidSubmit="Create">
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(ViewModel.Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">@ViewModel.Model.ErrorMessage</div>
                    }
                    @if (ViewModel.Model.IsSuccessful)
                    {
                        <div class="alert alert-success">Category created successfully!</div>
                    }
                    
                    <div class="mb-3">
                        <label class="form-label">Category Name</label>
                        <input class="form-control" @bind-value="ViewModel.Model.Name" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2 align-items-center">
                            @foreach (var c in ViewModel.Model.ColorOptions)
                            {
                                <button type="button" class="color-swatch btn btn-sm p-0" style="background-color:@c; border: none;" @onclick="() => ViewModel.SelectColorCommand.Execute(c)">
                                    <div class="swatch-inner @(c == ViewModel.Model.SelectedColor ? "swatch-selected" : "")" style="background-color:@c"></div>
                                </button>
                            }
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="OnCancel">Cancel</button>
                    <button class="btn btn-primary" type="submit" disabled="@ViewModel.Model.IsBusy">
                        @if (ViewModel.Model.IsBusy)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        }
                        Create Category
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    // LLM-Dev:v7 Refactored to use WNAB.MVM AddCategoryViewModel for shared business logic
    // Blazor modal now uses same ViewModel/Model as MAUI popup
    
    [Parameter] public EventCallback OnCategoryCreated { get; set; }

    protected override void OnInitialized()
    {
        // Subscribe to property changes to trigger UI updates
        ViewModel.Model.PropertyChanged += OnModelPropertyChanged;
    }

    private void OnModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        // When Model properties change, update the UI
        InvokeAsync(StateHasChanged);
    }

    private async Task Create()
    {
        var success = await ViewModel.Model.CreateCategoryAsync();
        
        if (success)
        {
            // Notify parent component to refresh the categories list
            await OnCategoryCreated.InvokeAsync();
            
            // Reset the form for next use
            ViewModel.Model.Reset();
        }
    }

    private void OnCancel()
    {
        ViewModel.Model.Reset();
    }

    public void Dispose()
    {
        if (ViewModel?.Model != null)
        {
            ViewModel.Model.PropertyChanged -= OnModelPropertyChanged;
        }
    }
}
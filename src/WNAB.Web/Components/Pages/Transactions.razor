@page "/transactions"
@inject TransactionsViewModel ViewModel
@inject WNAB.MVM.IAuthenticationService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="page-container">
    <div class="accounts-header">
        <div class="header-text">
            <h1 class="page-title">Transactions</h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="() => ViewModel.ToggleAddFormCommand.Execute(null)">
                <i class="bi bi-@(ViewModel.IsAddFormVisible ? "x-circle" : "plus-circle") me-1"></i>
                @(ViewModel.IsAddFormVisible ? "Cancel" : "New Transaction")
            </button>
            <button class="btn btn-secondary" @onclick="OnRefreshClick" disabled="@ViewModel.Model.IsBusy">
                @if (ViewModel.Model.IsBusy)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                }
                else
                {
                    <i class="bi bi-arrow-clockwise me-1"></i>
                }
                Refresh
            </button>
        </div>
    </div>

    @if (!ViewModel.Model.IsLoggedIn)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Please log in to view transactions.
        </div>
    }

<!-- Inline Add Transaction Form -->
@if (ViewModel.IsAddFormVisible && ViewModel.Model.IsLoggedIn)
{
	<div class="card mb-4 shadow-sm">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Transaction</h5>
		</div>
		<div class="card-body">
			@if (!string.IsNullOrWhiteSpace(ViewModel.AddTransactionViewModel.Model.StatusMessage))
			{
				<div class="alert @GetAlertClass(ViewModel.AddTransactionViewModel.Model.StatusMessage) mb-3">
					@ViewModel.AddTransactionViewModel.Model.StatusMessage
				</div>
			}

			<EditForm Model="ViewModel.AddTransactionViewModel.Model" OnValidSubmit="OnCreateTransactionSubmit">
				<div class="row g-3">
					<div class="col-md-3">
						<label class="form-label">Account</label>
						<select class="form-select" @bind="ViewModel.AddTransactionViewModel.Model.AccountId" required>
							<option value="0">Select account...</option>
							@foreach (var account in ViewModel.AddTransactionViewModel.Model.AvailableAccounts)
							{
								<option value="@account.Id">@account.AccountName</option>
							}
						</select>
					</div>
					<div class="col-md-3">
						<label class="form-label">Date</label>
						<input type="date" class="form-control" @bind="ViewModel.AddTransactionViewModel.Model.TransactionDate" required />
					</div>
					<div class="col-md-3">
						<label class="form-label">Payee</label>
						<input class="form-control" @bind="ViewModel.AddTransactionViewModel.Model.Payee" required />
					</div>
					<div class="col-md-3">
						<label class="form-label">Amount</label>
						<input type="number" step="0.01" class="form-control" @bind="ViewModel.AddTransactionViewModel.Model.Amount" required />
					</div>
				</div>

				<div class="row g-3 mt-2">
					<div class="col-md-9">
						<label class="form-label mb-2">Category <small class="text-muted">(for @ViewModel.AddTransactionViewModel.Model.TransactionDate.ToString("MMMM yyyy"))</small></label>

						<div class="border rounded p-3 bg-light">
							@foreach (var split in ViewModel.AddTransactionViewModel.Model.Splits)
							{
								<div class="row g-2 mb-2 align-items-center">
									<div class="col-md-6">
										<select class="form-select form-select-sm"
												value="@(split.Model.SelectedCategory?.Id ?? -1)"
												@onchange="(e) => OnSplitCategoryChanged(split, e)">
											@foreach (var category in ViewModel.AddTransactionViewModel.Model.AvailableCategories)
											{
												<option value="@category.Id">@category.Name</option>
											}
										</select>
									</div>
									<div class="col-md-4">
										<input type="number" step="0.01" class="form-control form-control-sm"
											   @bind="split.Model.Amount" placeholder="0.00" />
									</div>
									<div class="col-md-2">
										<button type="button" class="btn btn-sm btn-danger w-100"
												@onclick="() => ViewModel.AddTransactionViewModel.RemoveSplitCommand.Execute(split)"
												disabled="@(ViewModel.AddTransactionViewModel.Model.Splits.Count <= 1)">
											âœ•
										</button>
									</div>
								</div>
							}

							<button type="button" class="btn btn-sm btn-success mb-2" @onclick="ViewModel.AddTransactionViewModel.AddSplitCommand.Execute">
								+ Add Split
							</button>

							<div class="d-flex align-items-center gap-2 mt-2">
								<small class="text-muted">Balance:</small>
								<small class="fw-bold @(ViewModel.AddTransactionViewModel.Model.AreSplitsBalanced ? "text-success" : "text-danger")">
									@ViewModel.AddTransactionViewModel.Model.RemainingAmount.ToString("C")
								</small>
								<small class="text-muted">remaining</small>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<label class="form-label">Memo (Optional)</label>
						<textarea class="form-control" rows="3" @bind="ViewModel.AddTransactionViewModel.Model.Memo"></textarea>
					</div>
				</div>

				<div class="d-flex justify-content-end gap-2 mt-3">
					<button type="button" class="btn btn-secondary" @onclick="() => ViewModel.CancelAddTransactionCommand.Execute(null)">Cancel</button>
					<button class="btn btn-primary" type="submit" disabled="@ViewModel.AddTransactionViewModel.Model.IsBusy">
						@if (ViewModel.AddTransactionViewModel.Model.IsBusy)
						{
							<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
						}
						Create Transaction
					</button>
				</div>
			</EditForm>
		</div>
	</div>
}

<!-- Transactions with Splits Section -->
<div class="responsive-panel mb-4">
	@if (ViewModel.Model.Items == null)
	{
		<div class="text-center p-4">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
			<p class="mt-2 text-muted">Loading transactions...</p>
		</div>
	}
	else if (ViewModel.Model.Items.Count == 0)
	{
		<div class="text-center p-4">
			<i class="bi bi-receipt fs-1 text-muted"></i>
			<p class="mt-2">No transactions found. Click "New Transaction" to add your first transaction.</p>
		</div>
	}
	else
	{
		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th>Date</th>
						<th>Payee</th>
						<th>Account</th>
						<th class="text-end">Amount</th>
						<th width="140">Actions</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var transaction in ViewModel.Model.Items)
					{
						var isEditing = ViewModel.EditingTransactionId == transaction.Id;
						
						@if (!isEditing)
						{
							<!-- Read-Only Transaction Row -->
							<tr class="table-primary" @key="@($"tx-{transaction.Id}")">
								<td>@transaction.Date.ToString("MM/dd/yyyy")</td>
								<td><strong>@transaction.Payee</strong></td>
								<td>@transaction.AccountName</td>
								<td class="text-end">
									<span class="@(transaction.Amount >= 0 ? "text-success" : "text-danger") fw-bold">
										@transaction.Amount.ToString("C")
									</span>
								</td>
								<td>
									<button class="btn btn-sm btn-outline-primary" @onclick="() => StartEditTransaction(transaction.Id)" title="Edit Transaction">
										<i class="bi bi-pencil"></i>
									</button>
									<button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteTransaction(transaction.Id)" title="Delete Transaction">
										<i class="bi bi-trash"></i>
									</button>
								</td>
							</tr>

							<!-- Read-Only Split Rows -->
							@foreach (var split in transaction.Splits)
							{
								<tr class="table-light" @key="@($"split-{split.Id}")">
									<td class="ps-5">
										<i class="bi bi-arrow-return-right me-2 text-muted"></i>
										<small class="text-muted">Split #@split.Id</small>
									</td>
									<td colspan="2">
										@split.CategoryName
										@if (!string.IsNullOrWhiteSpace(split.Description))
										{
											<small class="text-muted ms-2">@split.Description</small>
										}
									</td>
									<td class="text-end">
										<span class="@(split.Amount >= 0 ? "text-success" : "text-danger")">
											@split.Amount.ToString("C")
										</span>
									</td>
									<td></td>
								</tr>
							}
						}
						else
						{
							<!-- Inline Edit Transaction Row -->
							<tr class="table-warning" style="border: 2px solid #ffc107;" @key="@($"tx-edit-{transaction.Id}")">
								<td colspan="5" class="p-0">
									<div class="p-3" style="background-color: #fff3cd;">
										<div class="row g-2 mb-2">
											<div class="col-md-3">
												<label class="form-label small">Date</label>
												<input type="date" class="form-control form-control-sm" @bind="ViewModel.EditTransactionViewModel.Model.TransactionDate" />
											</div>
											<div class="col-md-3">
												<label class="form-label small">Payee</label>
												<input class="form-control form-control-sm" @bind="ViewModel.EditTransactionViewModel.Model.Payee" />
											</div>
											<div class="col-md-3">
												<label class="form-label small">Account</label>
												<select class="form-select form-select-sm" @bind="ViewModel.EditTransactionViewModel.Model.AccountId">
													<option value="0">Select account...</option>
													@foreach (var account in ViewModel.EditTransactionViewModel.Model.AvailableAccounts)
													{
														<option value="@account.Id">@account.AccountName</option>
													}
												</select>
											</div>
											<div class="col-md-3">
												<label class="form-label small">Amount</label>
												<input type="number" step="0.01" class="form-control form-control-sm" @bind="ViewModel.EditTransactionViewModel.Model.Amount" />
											</div>
										</div>
										<div class="row g-2 mb-3">
											<div class="col-md-12">
												<label class="form-label small">Memo</label>
												<input class="form-control form-control-sm" @bind="ViewModel.EditTransactionViewModel.Model.Description" />
											</div>
										</div>

										<!-- Editable Splits Section -->
										<div class="mb-3">
											<h6 class="mb-2">Splits <small class="text-muted fw-normal">(for @ViewModel.EditTransactionViewModel.Model.TransactionDate.ToString("MMMM yyyy"))</small></h6>
											@foreach (var split in ViewModel.EditTransactionViewModel.Model.Splits.Where(s => !s.IsMarkedForDeletion))
											{
												<div class="row g-2 mb-2 align-items-end" @key="@($"edit-split-{split.Id}-{split.GetHashCode()}")">
													<div class="col-md-4">
														<label class="form-label small">Category</label>
														<select class="form-select form-select-sm" 
																value="@(split.SelectedCategory?.Id ?? -1)"
																@onchange="(e) => OnEditSplitCategoryChanged(split, e)">
															@foreach (var category in ViewModel.EditTransactionViewModel.Model.AvailableCategories)
															{
																<option value="@category.Id">@category.Name</option>
															}
														</select>
													</div>
													<div class="col-md-3">
														<label class="form-label small">Amount</label>
														<input type="number" step="0.01" class="form-control form-control-sm" @bind="split.Amount" />
													</div>
													<div class="col-md-4">
														<label class="form-label small">Notes</label>
														<input class="form-control form-control-sm" @bind="split.Description" />
													</div>
													<div class="col-md-1">
														<button type="button" class="btn btn-sm btn-danger w-100" 
																@onclick="() => MarkSplitForDeletion(split)" 
																title="Delete Split"
																disabled="@(ViewModel.EditTransactionViewModel.Model.Splits.Count(s => !s.IsMarkedForDeletion) <= 1)">
															<i class="bi bi-trash"></i>
														</button>
													</div>
												</div>
											}
											<button type="button" class="btn btn-sm btn-success mt-2" @onclick="AddEditingSplit">
												<i class="bi bi-plus-circle me-1"></i> Add Split
											</button>

											@if (!AreSplitsBalanced)
											{
												<div class="alert alert-danger mt-2 mb-0 py-2">
													<small><i class="bi bi-exclamation-triangle me-1"></i>Splits must sum to transaction amount. Current difference: @GetSplitDifference().ToString("C")</small>
												</div>
											}
										</div>

										<!-- Save/Cancel Buttons -->
										<div class="d-flex justify-content-end gap-2 mt-3">
											<button type="button" class="btn btn-sm btn-secondary" @onclick="CancelEditTransaction">
												Cancel
											</button>
											<button type="button" class="btn btn-sm btn-primary" @onclick="SaveEditTransaction" disabled="@(!AreSplitsBalanced)">
												Save Transaction
											</button>
										</div>
									</div>
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>
	}
</div>
</div>

@code {
	// LLM-Dev: Thin presentation layer - all logic delegated to ViewModel

	// Computed property for split balance validation
	private bool AreSplitsBalanced => ViewModel.EditingTransactionId.HasValue 
		? Math.Abs(GetSplitDifference()) < 0.01m 
		: true;
	
	private decimal GetSplitDifference() 
	{
		if (!ViewModel.EditingTransactionId.HasValue) return 0;
		var activeSplits = ViewModel.EditTransactionViewModel.Model.Splits.Where(s => !s.IsMarkedForDeletion);
		return ViewModel.EditTransactionViewModel.Model.Amount - activeSplits.Sum(s => s.Amount);
	}

	protected override async Task OnInitializedAsync()
	{
		// Check if user is authenticated and token is valid
		if (AuthService is WNAB.Web.Services.WebAuthenticationService webAuthService)
		{
			var isAuthenticated = await AuthService.IsAuthenticatedAsync();
			var isTokenExpired = await webAuthService.IsTokenExpiredAsync();

			if (!isAuthenticated || isTokenExpired)
			{
				Navigation.NavigateTo("/landing");
				return;
			}
		}

		// Subscribe to property changes to trigger UI updates
		ViewModel.PropertyChanged += OnViewModelPropertyChanged;
		ViewModel.Model.PropertyChanged += OnModelPropertyChanged;
		ViewModel.AddTransactionViewModel.Model.PropertyChanged += OnAddTransactionModelPropertyChanged;
		ViewModel.EditTransactionViewModel.Model.PropertyChanged += OnEditTransactionModelPropertyChanged;

		await ViewModel.InitializeAsync();
	}

	private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
	{
		InvokeAsync(StateHasChanged);
	}

	private void OnModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
	{
		InvokeAsync(StateHasChanged);
	}

	private void OnAddTransactionModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
	{
		InvokeAsync(StateHasChanged);
	}

	private void OnEditTransactionModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
	{
		InvokeAsync(StateHasChanged);
	}

	private async Task OnRefreshClick()
	{
		await ViewModel.RefreshCommand.ExecuteAsync(null);
	}

	// Form submit handlers
	private async Task OnCreateTransactionSubmit()
	{
		await ViewModel.SaveTransactionInlineCommand.ExecuteAsync(null);
	}

	// Inline editing methods - now delegates to ViewModel
	private async Task StartEditTransaction(int transactionId)
	{
		// Cancel any other editing first
		if (ViewModel.EditingTransactionId.HasValue && ViewModel.EditingTransactionId.Value != transactionId)
		{
			ViewModel.CancelEditTransactionCommand.Execute(null);
		}

		// Load the transaction into the EditTransactionViewModel
		await ViewModel.ModifyTransactionCommand.ExecuteAsync(transactionId);
	}

	private void CancelEditTransaction()
	{
		ViewModel.CancelEditTransactionCommand.Execute(null);
	}

	private async Task SaveEditTransaction()
	{
		// The ViewModel's SaveEditTransactionCommand handles everything including splits
		await ViewModel.SaveEditTransactionCommand.ExecuteAsync(null);
	}

	private void AddEditingSplit()
	{
		ViewModel.EditTransactionViewModel.Model.AddNewSplit();
		StateHasChanged();
	}

	private void MarkSplitForDeletion(EditableSplitItem split)
	{
		ViewModel.EditTransactionViewModel.Model.MarkSplitForDeletion(split);
		StateHasChanged();
	}

	// Helper method for edit split category selection
	private void OnEditSplitCategoryChanged(EditableSplitItem split, ChangeEventArgs e)
	{
		if (e.Value != null && int.TryParse(e.Value.ToString(), out int categoryId))
		{
			// Find the category from the AvailableCategories list (includes Income with Id=-1)
			var category = ViewModel.EditTransactionViewModel.Model.AvailableCategories.FirstOrDefault(c => c.Id == categoryId);
			split.SelectedCategory = category;
			StateHasChanged();
		}
	}

	// Helper methods for split category selection in Add form
	private int GetSelectedCategoryId(AddTransactionSplitViewModel split)
	{
		return split.Model.SelectedCategory?.Id ?? -1;
	}

	private void OnSplitCategoryChanged(AddTransactionSplitViewModel split, ChangeEventArgs e)
	{
		if (e.Value != null && int.TryParse(e.Value.ToString(), out int categoryId))
		{
			// Find the category from the AvailableCategories list (includes Income with Id=-1)
			var category = ViewModel.AddTransactionViewModel.Model.AvailableCategories.FirstOrDefault(c => c.Id == categoryId);
			split.Model.SelectedCategory = category;
			StateHasChanged();
		}
	}

	// Action handlers for transactions
	private async Task DeleteTransaction(int transactionId)
	{
		if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this transaction?"))
		{
			await ViewModel.DeleteTransactionCommand.ExecuteAsync(transactionId);
		}
	}

	private string GetAlertClass(string message)
	{
		if (message.Contains("Error") || message.Contains("Please") || message.Contains("Missing") || message.Contains("No "))
			return "alert-danger";
		if (message.Contains("success"))
			return "alert-success";
		return "alert-info";
	}

	public void Dispose()
	{
		if (ViewModel != null)
		{
			ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
		}
		if (ViewModel?.Model != null)
		{
			ViewModel.Model.PropertyChanged -= OnModelPropertyChanged;
		}
		if (ViewModel?.AddTransactionViewModel?.Model != null)
		{
			ViewModel.AddTransactionViewModel.Model.PropertyChanged -= OnAddTransactionModelPropertyChanged;
		}
		if (ViewModel?.EditTransactionViewModel?.Model != null)
		{
			ViewModel.EditTransactionViewModel.Model.PropertyChanged -= OnEditTransactionModelPropertyChanged;
		}
	}
}
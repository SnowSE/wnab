@page "/onboarding"
@using WNAB.Web.Components.Pages
@inject NavigationManager Navigation
@inject CategoriesViewModel CategoriesVM
@inject AccountsViewModel AccountsVM

@* Wizard Step State *@
@code {
    private WizardStep CurrentStep = WizardStep.Welcome;

    private enum WizardStep
    {
        Welcome,
        Categories,
        Accounts,
        Budget,
        Transactions,
        Review,
        Goodbye
    }

    protected override async Task OnInitializedAsync()
    {
        await CategoriesVM.InitializeAsync();
        await AccountsVM.InitializeAsync();

        // Subscribe to property changes so wizard updates when accounts/categories change
        CategoriesVM.Model.PropertyChanged += OnModelChanged;
        AccountsVM.Model.PropertyChanged += OnModelChanged;
    }

    private void OnModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void NextStep()
    {
        if (CurrentStep < WizardStep.Goodbye)
            CurrentStep++;
    }

    private void PrevStep()
    {
        if (CurrentStep > WizardStep.Welcome)
            CurrentStep--;
    }

    private void ExitWizard()
    {
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        CategoriesVM.Model.PropertyChanged -= OnModelChanged;
        AccountsVM.Model.PropertyChanged -= OnModelChanged;
    }
}

<div class="wizard-container">
    <div class="wizard-content">
        @if (CurrentStep == WizardStep.Categories)
        {
            <div class="wizard-highlight wizard-highlight-categories"></div>
            <Categories />
        }
        else if (CurrentStep == WizardStep.Accounts)
        {
            <div class="wizard-highlight wizard-highlight-accounts"></div>
            <Accounts />
        }
        else if (CurrentStep == WizardStep.Budget || CurrentStep == WizardStep.Review)
        {
            <div class="wizard-highlight wizard-highlight-budget"></div>
            <Home />
        }
        else if (CurrentStep == WizardStep.Transactions)
        {
            <div class="wizard-highlight wizard-highlight-transactions"></div>
            <Transactions />
        }
    </div>

    <div class="wizard-modal-sidebar">
        <div class="wizard-modal">
            @if (CurrentStep == WizardStep.Welcome)
            {
                <h2>Welcome to WNAB!</h2>
                <p>This wizard will help you set up your budget and teach you the basics of WNAB.</p>
                <button class="btn btn-primary" @onclick="NextStep">Start</button>
            }
            else if (CurrentStep == WizardStep.Categories)
            {
                <h2>Step 1: Set Up Categories</h2>
                <p>Add categories for things you expect to spend money on.</p>
                <button class="btn btn-secondary" @onclick="PrevStep">Back</button>
                <button class="btn btn-primary" @onclick="NextStep" disabled="@(CategoriesVM.Model.Items == null || CategoriesVM.Model.Items.Count == 0)">Next</button>
                @if (CategoriesVM.Model.Items != null && CategoriesVM.Model.Items.Count == 0)
                {
                    <div class="text-danger mt-2">Please add at least one category to continue.</div>
                }
            }
            else if (CurrentStep == WizardStep.Accounts)
            {
                <h2>Step 2: Add Bank Account(s)</h2>
                <p>Enter your bank account(s) and starting income.</p>
                <button class="btn btn-secondary" @onclick="PrevStep">Back</button>
                <button class="btn btn-primary" @onclick="NextStep" disabled="@(AccountsVM.Model.Items == null || AccountsVM.Model.Items.Count == 0)">Next</button>
                @if (AccountsVM.Model.Items != null && AccountsVM.Model.Items.Count == 0)
                {
                    <div class="text-danger mt-2">Please add at least one account to continue.</div>
                }
            }
            else if (CurrentStep == WizardStep.Budget)
            {
                <h2>Step 3: Make a Budget</h2>
                <p>Set allocations for each category.</p>
                <button class="btn btn-secondary" @onclick="PrevStep">Back</button>
                <button class="btn btn-primary" @onclick="NextStep">Next</button>
            }
            else if (CurrentStep == WizardStep.Transactions)
            {
                <h2>Step 4: Enter a Transaction</h2>
                <p>Enter a transaction, set the category and amount, and learn about marking income.</p>
                <button class="btn btn-secondary" @onclick="PrevStep">Back</button>
                <button class="btn btn-primary" @onclick="NextStep">Next</button>
            }
            else if (CurrentStep == WizardStep.Review)
            {
                <h2>Step 5: Review Your Budget</h2>
                <p>See how your transaction reflects in the budget page and learn about Ready To Assign (RTA).</p>
                <button class="btn btn-secondary" @onclick="PrevStep">Back</button>
                <button class="btn btn-primary" @onclick="NextStep">Finish</button>
            }
            else if (CurrentStep == WizardStep.Goodbye)
            {
                <h2>All Done!</h2>
                <p>You're ready to use WNAB. Good luck and happy budgeting!</p>
                <button class="btn btn-primary" @onclick="ExitWizard">Exit Wizard</button>
            }
        </div>
    </div>
</div>

<link rel="stylesheet" href="css/OnboardingWizard.css" />

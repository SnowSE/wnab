@using WNAB.MVM
@using Microsoft.AspNetCore.Components.Forms
@inject EditCategoryViewModel ViewModel
@implements IDisposable

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <EditForm Model="ViewModel.Model" OnValidSubmit="Update">
                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(ViewModel.Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">@ViewModel.Model.ErrorMessage</div>
                    }
                    
                    <div class="mb-3">
                        <label class="form-label">Category Name</label>
                        <input class="form-control" @bind-value="ViewModel.Model.Name" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2 flex-wrap">
                            @foreach (var c in colorOptions)
                            {
                                <button type="button" 
                                        class="btn btn-sm p-0" 
                                        style="width: 40px; height: 40px; background-color:@c; border: 3px solid @(c == ViewModel.Model.SelectedColor ? "#000" : "transparent"); border-radius: 50%;" 
                                        @onclick="() => ViewModel.SelectColorCommand.Execute(c)">
                                </button>
                            }
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActiveCheck" @bind="ViewModel.Model.IsActive" />
                        <label class="form-check-label" for="isActiveCheck">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick="OnCancel">Cancel</button>
                    <button class="btn btn-primary" type="submit">
                        Update Category
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnCategoryUpdated { get; set; }

    private List<string> colorOptions = new()
    {
        "#ef4444", "#f59e0b", "#10b981", "#3b82f6",
        "#6366f1", "#7c3aed", "#ec4899", "#14b8a6"
    };

    protected override void OnInitialized()
    {
        // Subscribe to property changes to trigger UI updates
        ViewModel.Model.PropertyChanged += OnModelPropertyChanged;
    }

    private void OnModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        // When Model properties change, update the UI
        InvokeAsync(StateHasChanged);
    }

    public void Initialize(int id, string name, string? color, bool isActive)
    {
        ViewModel.Initialize(id, name, color, isActive);
    }

    private async Task Update()
    {
        var success = await ViewModel.Model.UpdateCategoryAsync();
        
        if (success)
        {
            // Notify parent component to refresh the categories list
            await OnCategoryUpdated.InvokeAsync();
        }
    }

    private void OnCancel()
    {
        ViewModel.Model.ErrorMessage = null;
    }

    public void Dispose()
    {
        if (ViewModel?.Model != null)
        {
            ViewModel.Model.PropertyChanged -= OnModelPropertyChanged;
        }
    }
}

name: Deploy with azd up

on:
  workflow_dispatch:    # Manual trigger
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------- Checkout ----------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------- Install azd ----------------------
      - name: Install Azure Developer CLI (azd)
        run: |
          AZD_VERSION="1.20.0"  # replace with the latest version if needed
          curl -sSL https://github.com/Azure/azure-dev/releases/download/v$AZD_VERSION/azd-linux-x64.tar.gz | tar -xz -C /usr/local/bin
          azd version

      # ---------------------- AIDAN ----------------------
      - name: Login Aidan
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AIDAN_AZURE }}

      - name: Clear azd auth cache
        run: azd auth logout --purge || true

      - name: Set Aidan environment
        run: azd env select ${{ secrets.AIDAN_ENV_NAME }} || azd env new ${{ secrets.AIDAN_ENV_NAME }}

      - name: Deploy Aidan
        run: azd up --no-prompt

      # ---------------------- OMNER ----------------------
      - name: Login Omner
        uses: azure/login@v2
        with:
          creds: ${{ secrets.OMNER_AZURE }}

      - name: Clear azd auth cache
        run: azd auth logout --purge || true

      - name: Set Omner environment
        run: azd env select ${{ secrets.OMNER_ENV_NAME }} || azd env new ${{ secrets.OMNER_ENV_NAME }}

      - name: Deploy Omner
        run: azd up --no-prompt

      # ---------------------- KADEN ----------------------
      # - name: Login Kaden
      #   uses: azure/login@v2
      #   with:
      #     creds: ${{ secrets.KADEN_AZURE }}

      # - name: Clear azd auth cache
      #   run: azd auth logout --purge || true

      # - name: Set Kaden environment
      #   run: azd env select ${{ secrets.KADEN_ENV_NAME }} || azd env new ${{ secrets.KADEN_ENV_NAME }}

      # - name: Deploy Kaden
      #   run: azd up --no-prompt
